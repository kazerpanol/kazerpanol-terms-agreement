<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice-Highlight Terms with Volume Meter</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  margin: 0;
  padding: 0;
}

.card {
  max-width: 500px;
  margin: 50px auto;
  padding: 20px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

h2 {
  margin-top: 0;
}

.instruction {
  font-size: 14px;
  color: #444;
  margin-bottom: 10px;
}

#volumeMeter {
  display: block;
  margin: 0 auto 15px;
  background: #f0f0f0;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  position: relative;
}

#volumeLevel {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #ffd966;
  transform: scale(0);
  transform-origin: center;
  transition: transform 0.05s linear;
}

.read-zone {
  margin: 15px 0;
  padding: 15px;
  background: #ffffff;
  border-left: 4px solid #ffb700;
  border-radius: 6px;
}

.word {
  padding: 2px 2px;
  margin: 0 2px;
  display: inline-block;
  background-color: #f0f0f0;
  border-radius: 3px;
}

.word.read {
  background-color: #ffd966;
}

button {
  margin-top: 10px;
  padding: 10px 14px;
  background: #007bff;
  border: none;
  color: white;
  border-radius: 6px;
  cursor: pointer;
  width: 100%;
  font-size: 16px;
}

button:disabled {
  background: #aaa;
  cursor: not-allowed;
}

.agree {
  display: block;
  margin-top: 20px;
  font-size: 14px;
}
</style>
</head>
<body>

<div class="card">
  <h2>Terms & Agreement 5</h2>
  <p class="instruction">Please read aloud. Spoken words will be highlighted in real-time.</p>

  <!-- Volume Indicator -->
  <div id="volumeMeter">
    <div id="volumeLevel"></div>
  </div>

  <div class="read-zone" id="readZone"></div>

  <button id="startBtn">ðŸŽ¤ Start Reading</button>

  <label class="agree">
    <input type="checkbox" id="agree" disabled />
    I have read and understood the Terms & Conditions
  </label>
</div>

<script>
// Terms text
const text = `By using this service, you agree that your personal data may be collected, processed, and stored in accordance with our Privacy Policy and Terms.`;

// Split text into words
const readZone = document.getElementById("readZone");
const words = text.split(" ");
words.forEach((word, i) => {
  const span = document.createElement("span");
  span.textContent = word + " ";
  span.className = "word";
  span.id = "word-" + i;
  readZone.appendChild(span);
});

const startBtn = document.getElementById("startBtn");
const checkbox = document.getElementById("agree");
const volumeLevel = document.getElementById("volumeLevel");

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
  startBtn.disabled = true;
  alert("Your browser does not support Speech Recognition. Use Chrome on Android or Desktop.");
}

let recognition;
let audioContext, analyser, microphone, dataArray;

startBtn.addEventListener("click", async () => {
  startBtn.disabled = true;

  // --- Start speech recognition ---
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onresult = (event) => {
    const transcript = Array.from(event.results)
      .map(r => r[0].transcript)
      .join(" ")
      .toLowerCase()
      .replace(/[^a-zA-Z ]/g, "");

    const spokenWords = transcript.split(/\s+/);

    words.forEach((word, i) => {
      const cleanWord = word.replace(/[^a-zA-Z]/g, "").toLowerCase();
      const span = document.getElementById("word-" + i);
      if (spokenWords.includes(cleanWord)) {
        span.classList.add("read");
      }
    });

    const allRead = words.every((_, i) => document.getElementById("word-" + i).classList.contains("read"));
    if (allRead) {
      checkbox.disabled = false;
      recognition.stop();
    }
  };

  recognition.onerror = (e) => {
    console.error(e);
    alert("Speech recognition error. Make sure your microphone is allowed.");
  };

  recognition.start();

  // --- Start Web Audio API for volume meter ---
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    microphone = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    microphone.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    animateVolume();
  } catch (err) {
    console.error(err);
  }
});

function animateVolume() {
  analyser.getByteFrequencyData(dataArray);
  let sum = 0;
  dataArray.forEach(v => sum += v);
  const avg = sum / dataArray.length;

  // Scale average to 0â€“1
  const scale = Math.min(1, avg / 50); // adjust sensitivity
  volumeLevel.style.transform = `scale(${scale})`;

  requestAnimationFrame(animateVolume);
}
</script>

</body>
</html>
